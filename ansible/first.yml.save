- name: T-Rex Setup 
  hosts: usa
  tasks:

########################################
# Install repositories on T-Rex server #
########################################

#  - name: Install FedoraProject Repo
#    yum:
#      name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
#  - name: Install needed repos stage 1
#    yum:
#      name: bc,emacs,gcc,git,lshw,pciutils,python3-devel,python3-pip 
#  - name: Install needed repos stage 2
#    yum:
#      name: python3-setuptools,tmux,tuned-profiles-cpu-partitioning
#  - name: Install needed repos stage 3
#    yum:
#      name: tar,wget,zeromq-devel
#  - name: Create symbolic link for python3 
#    file:
#      src: "/usr/bin/python3"
#      dest: "/usr/bin/python"
#      state: link
#  - name: Create symbolic link for pip3
#    file:
#      src: "/usr/bin/pip3"
#      dest: "/usr/bin/pip"
#      state: link

#####################################################
# Modify startup parameters for hugepages and iommu #
#####################################################

  - name: Checking for hugepages in grub step 1 (Fatal errors are normal here)
    shell: "cat /etc/default/grub | grep hugepages=32"
    register: hugepages_found
    ignore_errors: True
#  - debug:
#      var: hugepages_found
  - name: Adding hugepages in grub if needed step 1
    when: hugepages_found.rc != 0
    lineinfile:
      path: /etc/default/grub
      regexp: '(GRUB_CMDLINE_LINUX=")(.*")'
      line: '\1hugepages=32 \2'
      backrefs: yes
  - name: Checking for hugepages in grub step 2 (Fatal errors are normal here)
    shell: "cat /etc/default/grub | grep hugepagesz=1G"
    register: hugepages_found
    ignore_errors: True
#  - debug:
#      var: hugepages_found
  - name: Adding hugepages in grub if needed step 2
    when: hugepages_found.rc != 0
    lineinfile:
      path: /etc/default/grub
      regexp: '(GRUB_CMDLINE_LINUX=")(.*")'
      line: '\1hugepagesz=1G \2'
      backrefs: yes
  - name: Checking for hugepages in grub step 3 (Fatal errors are normal here)
    shell: "cat /etc/default/grub | grep default_hugepagesz=1G"
    register: hugepages_found
    ignore_errors: True
#  - debug:
#      var: hugepages_found
  - name: Adding hugepages in grub if needed step 3
    when: hugepages_found.rc != 0
    lineinfile:
      path: /etc/default/grub
      regexp: '(GRUB_CMDLINE_LINUX=")(.*")'
      line: '\1default_hugepagesz=1G \2'
      backrefs: yes
  - name: Checking for iommu in grub step 1 (Fatal errors are normal here)
    shell: "cat /etc/default/grub | grep iommu=pt"
    register: iommu_found
    ignore_errors: True
#  - debug:
#      var: iommu_found
  - name: Adding iommu in grub if needed step 1
    when: iommu_found.rc != 0
    lineinfile:
      path: /etc/default/grub 
      regexp: '(GRUB_CMDLINE_LINUX=")(.*")'
      line: '\1iommu=pt \2'
      backrefs: yes
  - name: Checking for iommu in grub step 2 (Fatal errors are normal here)
    shell: "cat /etc/default/grub | grep intel_iommu=on"
    register: iommu_found
    ignore_errors: True
#  - debug:
#      var: iommu_found
  - name: Adding iommu in grub if needed step 2
    when: iommu_found.rc != 0
    lineinfile:
      path: /etc/default/grub 
      regexp: '(GRUB_CMDLINE_LINUX=")(.*")'
      line: '\1intel_iommu=on \2'
      backrefs: yes
  - name: Tweak the kernel for hugepages and iommu step 1
    command: "grub2-editenv - unset kernelopts"
  - name: Tweak the kernel for hugepages and iommu step 2
    command: "grub2-mkconfig -o /boot/grub2/grub.cfg"

#################
# Install T-Rex #
#################

  - name: Creates t-rex directory
    file:
      path: /root/trex
      state: directory
  - name: Check that the t-rex is downloaded
    stat:
      path: /root/trex/v2.53.tar.gz
    register: stat_result
  - name: Download t-rex 2.53
    when: stat_result.stat.exists == False
    get_url:
      url: http://trex-tgn.cisco.com/trex/release/v2.53.tar.gz
      dest: /root/trex/v2.53.tar.gz
  - name: unzip trex files
    unarchive:
      src: /root/trex/v2.53.tar.gz
      dest: /root/trex






